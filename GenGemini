# Make by: Nguyá»…n Minh Tiáº¿n, 31231020122, Robot&Ai K49
# CÃ i Ä‘áº·t thÆ° viá»‡n cáº§n thiáº¿t
!pip install -q -U google-generativeai
!pip install -q matplotlib

import google.generativeai as genai
from PIL import Image
import io
import ipywidgets as widgets
from IPython.display import display, clear_output
import json
import re
import numpy as np

# --- Giao diá»‡n ngÆ°á»i dÃ¹ng ---
api_key_input = widgets.Password(description='Nháº­p API Key:', placeholder='DÃ¡n API Key cá»§a báº¡n vÃ o Ä‘Ã¢y', layout=widgets.Layout(width='500px'))
uploader_id = widgets.FileUpload(description='1. Táº£i lÃªn Giáº¥y tá»', button_style='primary')
uploader_contract = widgets.FileUpload(description='2. Táº£i lÃªn Há»£p Ä‘á»“ng', button_style='primary')

# ThÃªm cÃ¡c Ã´ nháº­p tá»a Ä‘á»™ Ä‘á»ƒ cáº¯t áº£nh thá»§ cÃ´ng
coord_x = widgets.IntText(value=125, description='x:', layout=widgets.Layout(width='150px'))
coord_y = widgets.IntText(value=135, description='y:', layout=widgets.Layout(width='150px'))
coord_w = widgets.IntText(value=428, description='w:', layout=widgets.Layout(width='150px'))
coord_h = widgets.IntText(value=128, description='h:', layout=widgets.Layout(width='150px'))
coords_box = widgets.HBox([coord_x, coord_y, coord_w, coord_h], layout=widgets.Layout(description='Tá»a Ä‘á»™ cáº¯t áº£nh:'))

process_button = widgets.Button(description='3. TrÃ­ch xuáº¥t & Äiá»n thÃ´ng tin', button_style='success', icon='cogs')
output_area = widgets.Output()

# --- HÃ m xá»­ lÃ½ chÃ­nh ---
def process_images(b):
    with output_area:
        clear_output()

        # BÆ°á»›c 0: Cáº¥u hÃ¬nh API vÃ  kiá»ƒm tra file
        try:
            genai.configure(api_key=api_key_input.value)
            model = genai.GenerativeModel("models/gemini-2.0-flash")
        except Exception as e:
            print(f"âŒ Lá»—i API Key: Vui lÃ²ng kiá»ƒm tra láº¡i. Chi tiáº¿t: {e}")
            return

        if not uploader_id.value or not uploader_contract.value:
            print("âš ï¸ Vui lÃ²ng táº£i lÃªn cáº£ hai tá»‡p.")
            return

        print("ğŸ”„ Báº¯t Ä‘áº§u xá»­ lÃ½...")
        
        # Láº¥y ná»™i dung áº£nh dÆ°á»›i dáº¡ng bytes
        id_content = next(iter(uploader_id.value.values()))['content']
        contract_content = next(iter(uploader_contract.value.values()))['content']
        
        # Chuyá»ƒn Ä‘á»•i áº£nh sang Ä‘á»‹nh dáº¡ng PIL Ä‘á»ƒ AI xá»­ lÃ½ vÃ  numpy Ä‘á»ƒ cáº¯t
        id_image_pil = Image.open(io.BytesIO(id_content))
        id_image_np = np.array(id_image_pil)
        contract_image = Image.open(io.BytesIO(contract_content))

        # Hiá»ƒn thá»‹ hÃ¬nh áº£nh Ä‘Ã£ táº£i lÃªn
        print("\n--- HÃ¬nh áº£nh Ä‘Ã£ táº£i lÃªn ---")
        display(widgets.HBox([widgets.Image(value=id_content, width=350), widgets.Image(value=contract_content, width=350)]))
        
        # === BÆ¯á»šC 1: Cáº¯t áº£nh thá»§ cÃ´ng theo tá»a Ä‘á»™ Ä‘Ã£ nháº­p ===
        print("\nâœ‚ï¸ Äang cáº¯t áº£nh theo tá»a Ä‘á»™ báº¡n cung cáº¥p...")
        try:
            x, y, w, h = coord_x.value, coord_y.value, coord_w.value, coord_h.value
            
            # Cáº¯t áº£nh báº±ng numpy slicing
            cropped_np = id_image_np[y:y+h, x:x+w]
            
            # Chuyá»ƒn láº¡i sang Ä‘á»‹nh dáº¡ng PIL Ä‘á»ƒ hiá»ƒn thá»‹
            cropped_pil = Image.fromarray(cropped_np)
            
            print("âœ… Cáº¯t áº£nh thÃ nh cÃ´ng!")
            
            # Chuyá»ƒn áº£nh Ä‘Ã£ cáº¯t thÃ nh bytes Ä‘á»ƒ hiá»ƒn thá»‹
            byte_arr = io.BytesIO()
            cropped_pil.save(byte_arr, format='PNG')
            cropped_bytes = byte_arr.getvalue()

            display(widgets.VBox([
                widgets.HTML("<b>áº¢nh Ä‘Ã£ cáº¯t theo tá»a Ä‘á»™:</b>"),
                widgets.Image(value=cropped_bytes)
            ]))
            
        except Exception as e:
            print(f"âŒ Lá»—i khi cáº¯t áº£nh: {e}. Vui lÃ²ng kiá»ƒm tra láº¡i tá»a Ä‘á»™.")

        # === BÆ¯á»šC 2: AI trÃ­ch xuáº¥t thÃ´ng tin chi tiáº¿t tá»« áº£nh gá»‘c ===
        try:
            print("\nğŸ“„ Äang Ä‘á»c toÃ n bá»™ thÃ´ng tin tá»« giáº¥y tá»...")
            # Thay Ä‘á»•i prompt Ä‘á»ƒ yÃªu cáº§u cÃ¡c key cá»¥ thá»ƒ hÆ¡n
            prompt_full_details = """
            HÃ£y trÃ­ch xuáº¥t táº¥t cáº£ cÃ¡c trÆ°á»ng thÃ´ng tin báº¡n tháº¥y trÃªn giáº¥y tá» nÃ y vÃ  tráº£ vá» dÆ°á»›i dáº¡ng má»™t Ä‘á»‘i tÆ°á»£ng JSON. 
            Sá»­ dá»¥ng cÃ¡c key sau: "so_ho_chieu", "ho", "ten", "ngay_sinh", "gioi_tinh", "so_cmnd", "noi_sinh", "ngay_cap", "ngay_het_han", "co_quan_cap".
            """
            response_full_details = model.generate_content([prompt_full_details, id_image_pil])
            # ThÃªm bÆ°á»›c lÃ m sáº¡ch Ä‘á»ƒ xá»­ lÃ½ lá»—i JSON
            clean_text = response_full_details.text.strip().replace('```json', '').replace('```', '')
            full_details_data = json.loads(clean_text)
            
            print("\n" + "-"*15 + " THÃ”NG TIN CHI TIáº¾T TRÃŠN GIáº¤Y Tá»œ " + "-"*15)
            for key, value in full_details_data.items():
                print(f"- {key.replace('_', ' ').title()}: {value}")
            print("-" * 55)

            # Láº¥y thÃ´ng tin cáº§n thiáº¿t cho há»£p Ä‘á»“ng
            ho_ten_full = f"{full_details_data.get('ho', '')} {full_details_data.get('ten', '')}".strip()
            id_data = {
                "ho_ten": ho_ten_full,
                "so_id": full_details_data.get('so_ho_chieu', 'N/A'),
                "ngay_sinh": full_details_data.get('ngay_sinh', 'N/A')
            }
            print(f"âœ… ÄÃ£ láº¥y thÃ´ng tin cáº§n thiáº¿t cho há»£p Ä‘á»“ng: {id_data.get('ho_ten')}")

            # TrÃ­ch xuáº¥t vÄƒn báº£n tá»« há»£p Ä‘á»“ng
            prompt_contract = "TrÃ­ch xuáº¥t toÃ n bá»™ ná»™i dung vÄƒn báº£n tá»« hÃ¬nh áº£nh há»£p Ä‘á»“ng nÃ y."
            response_contract = model.generate_content([prompt_contract, contract_image])
            contract_text = response_contract.text
            print("âœ… ÄÃ£ trÃ­ch xuáº¥t vÄƒn báº£n há»£p Ä‘á»“ng.")

        except Exception as e:
            print(f"âŒ Lá»—i trong quÃ¡ trÃ¬nh trÃ­ch xuáº¥t cá»§a AI: {e}")
            return
            
        # === BÆ¯á»šC 3: Äiá»n thÃ´ng tin vÃ o há»£p Ä‘á»“ng (ÄÃƒ Cáº¬P NHáº¬T) ===
        print("\nâœï¸  Äang Ä‘iá»n thÃ´ng tin vÃ o há»£p Ä‘á»“ng...")
        ho_ten, so_id, ngay_sinh = id_data.get("ho_ten"), id_data.get("so_id"), id_data.get("ngay_sinh")

        filled_contract_text = contract_text
        
        # DÃ¹ng regex Ä‘á»ƒ thay tháº¿ cÃ¡c trÆ°á»ng trá»‘ng trÆ°á»›c
        filled_contract_text = re.sub(r'(Äá»‹a chá»‰\s*:\s*)', r'\1(KhÃ´ng cÃ³ trÃªn giáº¥y tá»)', filled_contract_text, flags=re.IGNORECASE)
        filled_contract_text = re.sub(r'(Äiá»‡n thoáº¡i\s*:\s*)', r'\1(KhÃ´ng cÃ³ trÃªn giáº¥y tá»)', filled_contract_text, flags=re.IGNORECASE)

        # ChÃ¨n tÃªn Ä‘áº¡i diá»‡n vÃ o trÆ°á»›c
        filled_contract_text = re.sub(r'(Äáº¡i diá»‡n\s*:\s*)', rf'\1{ho_ten}', filled_contract_text, flags=re.IGNORECASE)

        # **ÄÃ¢y lÃ  pháº§n logic quan trá»ng Ä‘Æ°á»£c thÃªm vÃ o**
        # NÃ³ táº¡o ra má»™t khá»‘i vÄƒn báº£n chi tiáº¿t vÃ  thay tháº¿ tÃªn vá»«a chÃ¨n báº±ng khá»‘i chi tiáº¿t nÃ y.
        if ho_ten and ho_ten in filled_contract_text:
            # Táº¡o khá»‘i thÃ´ng tin chi tiáº¿t
            detailed_info = f"{ho_ten}\nSá»‘ há»™ chiáº¿u: {so_id}\nNgÃ y sinh: {ngay_sinh}"
            # Thay tháº¿ tÃªn Ä‘Æ¡n láº» báº±ng khá»‘i thÃ´ng tin chi tiáº¿t (chá»‰ thay tháº¿ láº§n xuáº¥t hiá»‡n Ä‘áº§u tiÃªn)
            filled_contract_text = filled_contract_text.replace(ho_ten, detailed_info, 1)

        print("âœ… HoÃ n táº¥t!")

        # === HIá»‚N THá»Š Káº¾T QUáº¢ CUá»I CÃ™NG ===
        print("\n" + "="*50)
        print(" Káº¾T QUáº¢ Há»¢P Äá»’NG ÄÃƒ ÄÆ¯á»¢C ÄIá»€N Tá»° Äá»˜NG ")
        print("="*50 + "\n")
        print(filled_contract_text)


# --- Hiá»ƒn thá»‹ giao diá»‡n vÃ  gÃ¡n sá»± kiá»‡n ---
process_button.on_click(process_images)
upload_buttons = widgets.HBox([uploader_id, uploader_contract])
display(api_key_input, upload_buttons, widgets.HTML("<b>Nháº­p tá»a Ä‘á»™ Ä‘á»ƒ cáº¯t áº£nh tá»« Giáº¥y tá»:</b>"), coords_box, process_button, output_area)
