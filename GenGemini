# Make by: Nguyá»…n Minh Tiáº¿n, 31231020122, Robot&Ai K49
# CÃ i Ä‘áº·t thÆ° viá»‡n cáº§n thiáº¿t cá»§a Google
!pip install -q -U google-generativeai

import google.generativeai as genai
from PIL import Image
import io
import ipywidgets as widgets
from IPython.display import display, clear_output
import json
import re

# --- Giao diá»‡n ngÆ°á»i dÃ¹ng ---
api_key_input = widgets.Password(description='Nháº­p API Key:', placeholder='DÃ¡n API Key cá»§a báº¡n vÃ o Ä‘Ã¢y', layout=widgets.Layout(width='500px'))
uploader_id = widgets.FileUpload(description='1. Táº£i lÃªn Giáº¥y tá»', button_style='primary')
uploader_contract = widgets.FileUpload(description='2. Táº£i lÃªn Há»£p Ä‘á»“ng', button_style='primary')
process_button = widgets.Button(description='3. TrÃ­ch xuáº¥t & Äiá»n thÃ´ng tin', button_style='success', icon='cogs')
output_area = widgets.Output()

# --- HÃ m xá»­ lÃ½ chÃ­nh ---
def process_images(b):
    with output_area:
        clear_output()

        # BÆ°á»›c 0: Cáº¥u hÃ¬nh API vÃ  kiá»ƒm tra file
        try:
            genai.configure(api_key=api_key_input.value)
            model = genai.GenerativeModel("models/gemini-2.0-flash")
        except Exception as e:
            print(f"âŒ Lá»—i API Key: Vui lÃ²ng kiá»ƒm tra láº¡i. Chi tiáº¿t: {e}")
            return

        if not uploader_id.value or not uploader_contract.value:
            print("âš ï¸ Vui lÃ²ng táº£i lÃªn cáº£ hai tá»‡p.")
            return

        print("ğŸ”„ Báº¯t Ä‘áº§u xá»­ lÃ½...")
        
        # Láº¥y ná»™i dung áº£nh dÆ°á»›i dáº¡ng bytes
        id_content = next(iter(uploader_id.value.values()))['content']
        contract_content = next(iter(uploader_contract.value.values()))['content']
        
        # Chuyá»ƒn Ä‘á»•i áº£nh sang Ä‘á»‹nh dáº¡ng PIL Ä‘á»ƒ AI xá»­ lÃ½
        id_image = Image.open(io.BytesIO(id_content))
        contract_image = Image.open(io.BytesIO(contract_content))

        # === (Má»šI) Hiá»ƒn thá»‹ hÃ¬nh áº£nh Ä‘Ã£ táº£i lÃªn ===
        print("\n--- HÃ¬nh áº£nh Ä‘Ã£ táº£i lÃªn ---")
        id_image_widget = widgets.Image(value=id_content, width=350, format='png')
        contract_image_widget = widgets.Image(value=contract_content, width=350, format='png')
        display(widgets.HBox([id_image_widget, contract_image_widget]))
        # ==========================================

        try:
            # === BÆ¯á»šC 1A: TrÃ­ch xuáº¥t vÃ  hiá»ƒn thá»‹ TOÃ€N Bá»˜ thÃ´ng tin chi tiáº¿t tá»« giáº¥y tá» ===
            print("\nğŸ“„ Äang Ä‘á»c toÃ n bá»™ thÃ´ng tin tá»« giáº¥y tá»...")
            prompt_full_details = "HÃ£y trÃ­ch xuáº¥t táº¥t cáº£ cÃ¡c trÆ°á»ng thÃ´ng tin báº¡n tháº¥y trÃªn giáº¥y tá» nÃ y vÃ  tráº£ vá» dÆ°á»›i dáº¡ng má»™t Ä‘á»‘i tÆ°á»£ng JSON. Sá»­ dá»¥ng tiáº¿ng Viá»‡t cho cÃ¡c key."
            response_full_details = model.generate_content([prompt_full_details, id_image])
            full_details_data = json.loads(response_full_details.text.strip().replace('```json', '').replace('```', ''))
            
            print("\n" + "-"*15 + " THÃ”NG TIN CHI TIáº¾T TRÃŠN GIáº¤Y Tá»œ " + "-"*15)
            for key, value in full_details_data.items():
                print(f"- {key.replace('_', ' ').title()}: {value}")
            print("-" * 55)

            # === BÆ¯á»šC 1B & 2: TrÃ­ch xuáº¥t thÃ´ng tin Cáº¦N THIáº¾T cho há»£p Ä‘á»“ng ===
            print("\nğŸ“‘ Äang trÃ­ch xuáº¥t thÃ´ng tin cáº§n thiáº¿t Ä‘á»ƒ Ä‘iá»n vÃ o há»£p Ä‘á»“ng...")
            prompt_id_for_contract = 'TrÃ­ch xuáº¥t "Passport No." (dÆ°á»›i key "so_id"), gá»™p "Surname" vÃ  "Given names" (dÆ°á»›i key "ho_ten"), "Date of birth" (dÆ°á»›i key "ngay_sinh") tá»« áº£nh. Chá»‰ tráº£ vá» JSON.'
            response_id = model.generate_content([prompt_id_for_contract, id_image])
            id_data = json.loads(response_id.text.strip().replace('```json', '').replace('```', ''))
            print(f"âœ… ÄÃ£ láº¥y thÃ´ng tin cáº§n thiáº¿t: {id_data.get('ho_ten')}")

            prompt_contract = "TrÃ­ch xuáº¥t toÃ n bá»™ ná»™i dung vÄƒn báº£n tá»« hÃ¬nh áº£nh há»£p Ä‘á»“ng nÃ y."
            response_contract = model.generate_content([prompt_contract, contract_image])
            contract_text = response_contract.text
            print("âœ… ÄÃ£ trÃ­ch xuáº¥t vÄƒn báº£n há»£p Ä‘á»“ng.")

        except Exception as e:
            print(f"âŒ Lá»—i trong quÃ¡ trÃ¬nh trÃ­ch xuáº¥t: {e}")
            return
            
        # === BÆ¯á»šC 3: Äiá»n thÃ´ng tin vÃ o há»£p Ä‘á»“ng ===
        print("\nâœï¸  Äang Ä‘iá»n thÃ´ng tin vÃ o há»£p Ä‘á»“ng...")
        ho_ten = id_data.get("ho_ten", "")
        so_id = id_data.get("so_id", "")
        ngay_sinh = id_data.get("ngay_sinh", "")

        replacements = {
            r'(Äá»‹a chá»‰\s*:\s*)': rf'\1(KhÃ´ng cÃ³ trÃªn giáº¥y tá»)',
            r'(Äiá»‡n thoáº¡i\s*:\s*)': rf'\1(KhÃ´ng cÃ³ trÃªn giáº¥y tá»)',
            r'(Äáº¡i diá»‡n\s*:\s*)': rf'\1{ho_ten}'
        }

        filled_contract_text = contract_text
        for pattern, replacement in replacements.items():
            filled_contract_text = re.sub(pattern, replacement, filled_contract_text, flags=re.IGNORECASE)

        if ho_ten:
            detailed_info = f"{ho_ten}\nSá»‘ há»™ chiáº¿u: {so_id}\nNgÃ y sinh: {ngay_sinh}"
            filled_contract_text = filled_contract_text.replace(ho_ten, detailed_info, 1)

        print("âœ… HoÃ n táº¥t!")

        # === HIá»‚N THá»Š Káº¾T QUáº¢ CUá»I CÃ™NG ===
        print("\n" + "="*50)
        print(" Káº¾T QUáº¢ Há»¢P Äá»’NG ÄÃƒ ÄÆ¯á»¢C ÄIá»€N Tá»° Äá»˜NG ")
        print("="*50 + "\n")
        print(filled_contract_text)

# --- Hiá»ƒn thá»‹ giao diá»‡n vÃ  gÃ¡n sá»± kiá»‡n ---
process_button.on_click(process_images)
upload_buttons = widgets.HBox([uploader_id, uploader_contract])
display(api_key_input, upload_buttons, process_button, output_area)
